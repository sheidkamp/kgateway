# EP-12721: E2e testing with Gateway API Versions


* Issue: [12721](https://github.com/kgateway-dev/kgateway/issues/12721)


## Background
The current e2e tests assume latest experimental version of the `gateway.networking.k8s.io` APIs are installed. This will not always be the case in the environments in which kgateway is deployed. In order to valdiate functionality across a wider range of environments, we will allow testing with different versions of the Gateway API.

In addition to different semvar designated versions of the API, there are two channels, `standard` and `experimental`

There are 3 suites that need to be updated to implement this
* [HeaderModifiers](/test/kubernetes/e2e/features/header_modifiers/suite.go)
* [MetricsTest](/test/kubernetes/e2e/features/metrics/suite.go)
* [ListenerSets](/test/kubernetes/e2e/features/listenerset/suite.go)

## Motivation
Better test coverage

## Goals
* E2E tests can be run locally or in CI with different versions (as defined by semver and channel) of the Gateway API
* Consistent approach to managing resources for different versions of the API

## Non-Goals
* Mass update of existing tests to use the BaseTestingSuite
  * Suites that don't use the BaseTestingSuite will continue to run all tests for any GatewayAPI version
  * All tests that will need to be modified/tagged appear to be using the BaseTestingSuite. If an exception is found, that test suite will be updated.


## Implementation Details
### Determinging the Gateway API version
The Gateway API CRDs contain two relevant annotations:
* `gateway.networking.k8s.io/bundle-version` - the API version, for example `gateway.networking.k8s.io/bundle-version: v1.2.0`
* `gateway.networking.k8s.io/channel` - the API channel, standard or experimental, for example `gateway.networking.k8s.io/channel: standard`

These annotations can be examined to determine the version. If the annotations are not present, that may be considered a fatal error.

### Test cases
The e2e tests are built up of [TestCases](https://github.com/kgateway-dev/kgateway/blob/2b04f3d1465257d0c449687922ea6e92603b822c/test/kubernetes/e2e/tests/base/base_suite.go#L33) that define the resources used for the tests.

In order to allow test cases to run conditionally based on the API version, we will add a new field, `GatewayApiVersion` to the TestCase struct:

```
	// GatewayApiVersion specifies the minimum Gateway API version required per channel.
	// Map key is the channel (GatewayApiChannelStandard or GatewayApiChannelExperimental), value is the minimum version.
	// If the map is empty/nil, the test runs on any channel/version.
	// Matching logic based on installed channel:
	//   - experimental: If experimental key exists, check version; otherwise run
	//   - standard: If standard key exists, check version; if only experimental exists, skip; otherwise runs on any standard version.
	GatewayApiVersion map[GatewayApiChannel]*semver.Version
```

`GatewayApiChannel` is a typed string with the value of `experimental` or `standard`, and will define the minimum version of the API needed to run the test for the channel. If no value is defined, the test can run on any version of the API. The exception to this logic is if the standard channel is installed and the `GatewayApiVersion` define on the TestCase on defined an expiermental minimum version, for example:

```
    GatewayApiVersion: map[base.GatewayApiChannel]*semver.Version{
        base.GwApiChannelExperimental: base.GwApiV1_4_0,
    },
```

This will be interpreted as "the test needs to use features available in experimental API v1.4.0; these features are not yet available in the standard channel".

If the installed version of the API does not meet the minimum requirements fo the test, the existing `Setup` will be used.

### Test Suites
A common pattern used in our e2e tests is to setup a Gateway and possibly other resources during suite setup and using them for every test. This pattern allows the tests to run faster, as time is not spent deploying and removing Gateways per test. In the [BaseTestingSuite](https://github.com/kgateway-dev/kgateway/blob/2b04f3d1465257d0c449687922ea6e92603b822c/test/kubernetes/e2e/tests/base/base_suite.go#L49C1-L66C2), these reources are defined by the [Setup](https://github.com/kgateway-dev/kgateway/blob/2b04f3d1465257d0c449687922ea6e92603b822c/test/kubernetes/e2e/tests/base/base_suite.go#L53) field

However, once we allow tests to run for different versions of the API, we are no longer in a "one configuration fits all" situation. For example, using XListenerSets requires `allowedListeners` to be defined on the Gateway, but this field will cause the resource to be rejected when using older versions of the API.

To accomodate this, we will add a new field `SetupByVersion` to the BaseTestingSuite:
```
	// SetupByVersion allows defining different setup configurations for different GW API versions and channels.
	// The outer map key is the channel (standard or experimental).
	// The inner map key is the minimum version, and the value is the TestCase to use.
	// The system will select the setup with the highest matching version for the current channel.
	// If no setups match, falls back to the Setup field.
	// Example:
	//   SetupByVersion: map[GatewayApiChannel]map[*semver.Version]*TestCase{
	//     GwApiChannelExperimental: {
	//       GwApiV1_4_0: &setupExperimentalV1_4,
	//     },
	//     GwApiChannelStandard: {
	//       GwApiV1_4_0: &setupStandardV1_4,
	//     },
	//   }
	SetupByVersion map[GatewayApiChannel]map[*semver.Version]*TestCase
```

When choosing which setup to use, the suite will use the highest defined semvar for the channel that is less than the current version, falling back to the existing `Setup` if there is no match.

There are other data structures that could be used to store the setup information. This approach was chosen because by making channel and version keys for the map, we guarantee that it will be unambiguous which setup to use.


### DevX
* This approach requires no changes for the majority of tests and suites.
* Once a suite has been setup to support a version, tests only need to be tagged


### Test Plan
It's all testing. Successful runs of a github job

## Alternatives
Do not test other versions of the API.

## Open Questions
* These implementations require 

<!--
Include any unresolved questions or areas requiring feedback.
-->
