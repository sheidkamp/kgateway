apiVersion: v1
kind: Namespace
metadata:
  name: agentgateway-base
---
kind: Gateway
apiVersion: gateway.networking.k8s.io/v1
metadata:
  name: gateway
  namespace: agentgateway-base
spec:
  gatewayClassName: agentgateway
  listeners:
    - protocol: HTTP
      port: 80
      name: http
      allowedRoutes:
        namespaces:
          from: All
---
apiVersion: v1
kind: Service
metadata:
  name: backend
  namespace: agentgateway-base
spec:
  ports:
    - name: http
      port: 80
    - name: https
      port: 443
    - name: tcp
      port: 9090
    - name: grpc
      port: 7070
  selector:
    app.kubernetes.io/name: backend
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: backend
  namespace: agentgateway-base
spec:
  selector:
    matchLabels:
      app.kubernetes.io/name: backend
  template:
    metadata:
      labels:
        app.kubernetes.io/name: backend
    spec:
      securityContext:
        sysctls:
        - name: net.ipv4.ip_unprivileged_port_start
          value: "0"
      containers:
      - image: gcr.io/istio-testing/app:latest
        imagePullPolicy: IfNotPresent
        name: backend
        resources:
          requests:
            cpu: "50m"
            memory: "64Mi"
        args:
          - --tcp=9090
          - --port=80
          - --grpc=7070
          - --port=443
          - --tls=443
          - --crt=/cert.crt
          - --key=/cert.key
        env:
        - name: INSTANCE_IP
          valueFrom:
            fieldRef:
              fieldPath: status.podIP
